<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLAME-ICU Federated Learning Visualization</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 40px;
            font-size: 1.2em;
        }
        h2 {
            color: #34495e;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin-top: 40px;
            font-size: 1.8em;
        }
        h3 {
            color: #546e7a;
            margin-top: 30px;
            font-size: 1.4em;
        }
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .overview-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: translateY(0);
            transition: transform 0.3s ease;
        }
        .overview-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .overview-card h4 {
            margin-top: 0;
            font-size: 1.2em;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 10px;
        }
        .overview-card ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .mermaid-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        .description {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 5px solid #667eea;
        }
        .key-points {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .key-points ul {
            margin: 10px 0;
            padding-left: 25px;
        }
        .key-points li {
            margin: 8px 0;
        }
        .timeline {
            background: #fff3e0;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        .timeline span {
            display: inline-block;
            margin: 0 10px;
            padding: 5px 15px;
            background: #ff9800;
            color: white;
            border-radius: 20px;
            font-weight: bold;
        }
        .legend {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .legend-item {
            display: inline-block;
            margin: 5px 15px;
        }
        .legend-color {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 5px;
            vertical-align: middle;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè• FLAME-ICU Federated Learning Implementation</h1>
        <p class="subtitle">Federated Learning Adaptable Mortality Estimator for the ICU</p>
        
        <div class="timeline">
            <strong>Data Timeline:</strong>
            <span>Training: 2018-2022</span>
            <span>Testing: 2023-2024</span>
        </div>

        <div class="overview-grid">
            <div class="overview-card">
                <h4>üìä Project Overview</h4>
                <ul>
                    <li>Main Site: RUSH (coordinator)</li>
                    <li>Federated Sites: 6-7 institutions</li>
                    <li>Data Format: CLIF standardized</li>
                    <li>Models: XGBoost & Neural Network</li>
                </ul>
            </div>
            <div class="overview-card">
                <h4>üéØ Stage 1 Goals</h4>
                <ul>
                    <li>Model development</li>
                    <li>Local testing</li>
                    <li>4 different approaches</li>
                    <li>Model sharing via BOX</li>
                </ul>
            </div>
            <div class="overview-card">
                <h4>üöÄ Stage 2 Goals</h4>
                <ul>
                    <li>Cross-site testing</li>
                    <li>Ensemble construction</li>
                    <li>Performance evaluation</li>
                    <li>Deployment recommendations</li>
                </ul>
            </div>
        </div>

        <h2>Stage 1: Model Development & Local Testing</h2>
        
        <h3>Approach 1: Cross-Site Model Validation</h3>
        <div class="description">
            <strong>Objective:</strong> Test generalization of centralized model across sites without local training
        </div>
        
        <div class="mermaid-container">
            <div class="mermaid">
                graph TB
                    subgraph "RUSH (Main Site)"
                        A[RUSH Training Data<br/>2018-2022] --> B[Train Models]
                        B --> C[XGBoost Model]
                        B --> D[Neural Network Model]
                    end
                    
                    subgraph "Model Distribution"
                        C --> E[Share Trained Models]
                        D --> E
                    end
                    
                    subgraph "Federated Sites Testing"
                        E --> F1[Site A<br/>Test: 2023-2024]
                        E --> F2[Site B<br/>Test: 2023-2024]
                        E --> F3[Site C<br/>Test: 2023-2024]
                        E --> F4[Site D<br/>Test: 2023-2024]
                        E --> F5[Sites E-G<br/>Test: 2023-2024]
                    end
                    
                    subgraph "Results Collection"
                        F1 --> G[Performance Metrics]
                        F2 --> G
                        F3 --> G
                        F4 --> G
                        F5 --> G
                        G --> H[Baseline Performance<br/>Analysis]
                    end
                    
                    style A fill:#e1f5fe
                    style B fill:#4fc3f7
                    style C fill:#81c784
                    style D fill:#81c784
                    style E fill:#ffb74d
                    style G fill:#ba68c8
                    style H fill:#f06292
            </div>
        </div>
        
        <div class="key-points">
            <strong>Key Points:</strong>
            <ul>
                <li>No local training at federated sites</li>
                <li>Pure generalization test</li>
                <li>Establishes baseline performance</li>
            </ul>
        </div>

        <h3>Approach 2: Transfer Learning with Main Model Initialization</h3>
        <div class="description">
            <strong>Objective:</strong> Fine-tune RUSH pre-trained model at each site for personalized adaptation
        </div>
        
        <div class="mermaid-container">
            <div class="mermaid">
                graph TB
                    subgraph "RUSH Base Model"
                        A[RUSH Training Data<br/>2018-2022] --> B[Pre-train Models]
                        B --> C[Base XGBoost]
                        B --> D[Base Neural Network]
                    end
                    
                    subgraph "Model Distribution"
                        C --> E[Share Base Models]
                        D --> E
                    end
                    
                    subgraph "Site-Specific Fine-tuning"
                        E --> F1[Site A]
                        E --> F2[Site B]
                        E --> F3[Site C]
                        E --> F4[Sites D-G]
                        
                        F1 --> G1[Local Data<br/>2018-2022]
                        F2 --> G2[Local Data<br/>2018-2022]
                        F3 --> G3[Local Data<br/>2018-2022]
                        F4 --> G4[Local Data<br/>2018-2022]
                        
                        G1 --> H1[Fine-tune<br/>LR: 0.1x]
                        G2 --> H2[Fine-tune<br/>LR: 0.1x]
                        G3 --> H3[Fine-tune<br/>LR: 0.1x]
                        G4 --> H4[Fine-tune<br/>LR: 0.1x]
                    end
                    
                    subgraph "Testing & Sharing"
                        H1 --> I1[Test 2023-2024]
                        H2 --> I2[Test 2023-2024]
                        H3 --> I3[Test 2023-2024]
                        H4 --> I4[Test 2023-2024]
                        
                        I1 --> J[Upload to BOX]
                        I2 --> J
                        I3 --> J
                        I4 --> J
                        J --> K[Stage 2 Collection]
                    end
                    
                    style A fill:#e1f5fe
                    style B fill:#4fc3f7
                    style E fill:#ffb74d
                    style H1 fill:#81c784
                    style H2 fill:#81c784
                    style H3 fill:#81c784
                    style H4 fill:#81c784
                    style J fill:#ba68c8
                    style K fill:#f06292
            </div>
        </div>
        
        <div class="key-points">
            <strong>Key Points:</strong>
            <ul>
                <li>Reduced learning rate (0.1x) for stable fine-tuning</li>
                <li>All layers trainable</li>
                <li>50% local data for fine-tuning</li>
                <li>Models uploaded to BOX for Stage 2</li>
            </ul>
        </div>

        <h3>Approach 3: Independent Site Training & Model Sharing</h3>
        <div class="description">
            <strong>Objective:</strong> Develop completely independent models at each site from scratch
        </div>
        
        <div class="mermaid-container">
            <div class="mermaid">
                graph TB
                    subgraph "Parallel Independent Training"
                        subgraph "Site A"
                            A1[Local Data<br/>2018-2022] --> B1[Train from Scratch]
                            B1 --> C1[XGBoost + NN]
                            C1 --> D1[Test 2023-2024]
                        end
                        
                        subgraph "Site B"
                            A2[Local Data<br/>2018-2022] --> B2[Train from Scratch]
                            B2 --> C2[XGBoost + NN]
                            C2 --> D2[Test 2023-2024]
                        end
                        
                        subgraph "Site C"
                            A3[Local Data<br/>2018-2022] --> B3[Train from Scratch]
                            B3 --> C3[XGBoost + NN]
                            C3 --> D3[Test 2023-2024]
                        end
                        
                        subgraph "Sites D-G"
                            A4[Local Data<br/>2018-2022] --> B4[Train from Scratch]
                            B4 --> C4[XGBoost + NN]
                            C4 --> D4[Test 2023-2024]
                        end
                    end
                    
                    subgraph "Model Collection"
                        D1 --> E[Manual Upload to BOX]
                        D2 --> E
                        D3 --> E
                        D4 --> E
                        E --> F[Stage 2 Collection]
                    end
                    
                    style A1 fill:#e1f5fe
                    style A2 fill:#e1f5fe
                    style A3 fill:#e1f5fe
                    style A4 fill:#e1f5fe
                    style B1 fill:#81c784
                    style B2 fill:#81c784
                    style B3 fill:#81c784
                    style B4 fill:#81c784
                    style E fill:#ba68c8
                    style F fill:#f06292
            </div>
        </div>
        
        <div class="key-points">
            <strong>Key Points:</strong>
            <ul>
                <li>No external influence on training</li>
                <li>Site-specific hyperparameter optimization</li>
                <li>Establishes local performance baselines</li>
                <li>Creates model diversity for ensembles</li>
            </ul>
        </div>

        <h3>Approach 4: Round Robin Federated Training</h3>
        <div class="description">
            <strong>Objective:</strong> Sequential collaborative training with models passed between sites
        </div>
        
        <div class="mermaid-container">
            <div class="mermaid">
                graph LR
                    subgraph "Round Robin Training Sequence"
                        A[RUSH<br/>Initialize & Train<br/>2018-2022] -->|Pass Model| B[Site A<br/>Continue Training<br/>10-20 epochs]
                        B -->|Pass Model| C[Site B<br/>Continue Training<br/>10-20 epochs]
                        C -->|Pass Model| D[Site C<br/>Continue Training<br/>10-20 epochs]
                        D -->|Pass Model| E[Site D<br/>Continue Training<br/>10-20 epochs]
                        E -->|Pass Model| F[Site E<br/>Continue Training<br/>10-20 epochs]
                        F -->|Pass Model| G[Site F<br/>Continue Training<br/>10-20 epochs]
                        G -->|Pass Model| H[Site G<br/>Continue Training<br/>10-20 epochs]
                    end
                    
                    H --> I[Final Round Robin Model]
                    
                    subgraph "Testing at All Sites"
                        I --> J1[RUSH Test<br/>2023-2024]
                        I --> J2[Site A Test<br/>2023-2024]
                        I --> J3[Site B Test<br/>2023-2024]
                        I --> J4[All Sites Test<br/>2023-2024]
                    end
                    
                    J1 --> K[Upload to BOX]
                    J2 --> K
                    J3 --> K
                    J4 --> K
                    K --> L[Stage 2 Collection]
                    
                    style A fill:#4fc3f7
                    style B fill:#81c784
                    style C fill:#81c784
                    style D fill:#81c784
                    style E fill:#81c784
                    style F fill:#81c784
                    style G fill:#81c784
                    style H fill:#81c784
                    style I fill:#ffb74d
                    style K fill:#ba68c8
                    style L fill:#f06292
            </div>
        </div>
        
        <div class="key-points">
            <strong>Key Points:</strong>
            <ul>
                <li>Fixed epochs per site (10-20)</li>
                <li>Adaptive learning rate decreases with rounds</li>
                <li>Increased regularization for later sites</li>
                <li>Accumulates knowledge from all sites</li>
            </ul>
        </div>

        <h2>Stage 2: Comprehensive Testing & Ensemble Evaluation</h2>
        
        <h3>Phase 1: Cross-Site Model Testing</h3>
        <div class="description">
            <strong>Objective:</strong> Test all models from Stage 1 across all participating sites
        </div>
        
        <div class="mermaid-container">
            <div class="mermaid">
                graph TB
                    subgraph "Model Collection from Stage 1"
                        A[BOX Folder] --> B[Transfer Learning Models]
                        A --> C[Independent Models]
                        A --> D[Round Robin Models]
                    end
                    
                    subgraph "Cross-Site Testing Matrix"
                        B --> E[Distribute to All Sites]
                        C --> E
                        D --> E
                        
                        E --> F1[Site A Tests:<br/>All Other Sites' Models]
                        E --> F2[Site B Tests:<br/>All Other Sites' Models]
                        E --> F3[Site C Tests:<br/>All Other Sites' Models]
                        E --> F4[Sites D-G Test:<br/>All Other Sites' Models]
                    end
                    
                    subgraph "Performance Analysis"
                        F1 --> G[Performance Matrix<br/>Models √ó Sites]
                        F2 --> G
                        F3 --> G
                        F4 --> G
                        
                        G --> H[Generalization Analysis]
                        G --> I[Site Similarity Assessment]
                        G --> J[Approach Comparison]
                    end
                    
                    style A fill:#ba68c8
                    style E fill:#ffb74d
                    style G fill:#4fc3f7
                    style H fill:#81c784
                    style I fill:#81c784
                    style J fill:#81c784
            </div>
        </div>

        <h3>Phase 2: Ensemble Construction & Testing</h3>
        <div class="description">
            <strong>Objective:</strong> Create and evaluate ensemble models using practical combination strategies
        </div>
        
        <div class="mermaid-container">
            <div class="mermaid">
                graph TB
                    subgraph "Leave-One-Out Ensemble Construction"
                        A[All Models from BOX] --> B{For Each Site}
                        
                        B --> C1[Site A Ensemble]
                        B --> C2[Site B Ensemble]
                        B --> C3[Site C Ensemble]
                        
                        C1 --> D1[Exclude Site A Models<br/>Include B,C,D,E,F,G]
                        C2 --> D2[Exclude Site B Models<br/>Include A,C,D,E,F,G]
                        C3 --> D3[Exclude Site C Models<br/>Include A,B,D,E,F,G]
                    end
                    
                    subgraph "Ensemble Strategies"
                        D1 --> E1[Simple Average<br/>Equal Weights]
                        D1 --> E2[Accuracy Weighted<br/>Based on Local AUC]
                        
                        D2 --> F1[Simple Average<br/>Equal Weights]
                        D2 --> F2[Accuracy Weighted<br/>Based on Local AUC]
                        
                        D3 --> G1[Simple Average<br/>Equal Weights]
                        D3 --> G2[Accuracy Weighted<br/>Based on Local AUC]
                    end
                    
                    subgraph "Local Testing & Evaluation"
                        E1 --> H1[Test on Site A<br/>2023-2024 Data]
                        E2 --> H1
                        
                        F1 --> H2[Test on Site B<br/>2023-2024 Data]
                        F2 --> H2
                        
                        G1 --> H3[Test on Site C<br/>2023-2024 Data]
                        G2 --> H3
                        
                        H1 --> I[Performance Comparison]
                        H2 --> I
                        H3 --> I
                        
                        I --> J[Deployment<br/>Recommendations]
                    end
                    
                    style A fill:#ba68c8
                    style B fill:#ffb74d
                    style E1 fill:#81c784
                    style E2 fill:#4fc3f7
                    style F1 fill:#81c784
                    style F2 fill:#4fc3f7
                    style G1 fill:#81c784
                    style G2 fill:#4fc3f7
                    style I fill:#f06292
                    style J fill:#ff5722
            </div>
        </div>
        
        <div class="key-points">
            <strong>Ensemble Key Points:</strong>
            <ul>
                <li><strong>Simple Average:</strong> Equal weighting, unbiased baseline, most transparent</li>
                <li><strong>Accuracy Weighted:</strong> Performance-driven, clinically intuitive, evidence-based</li>
                <li><strong>Leave-One-Out:</strong> Prevents overfitting, ensures unbiased evaluation</li>
                <li><strong>Recommendation:</strong> Accuracy Weighted Ensemble for clinical deployment</li>
            </ul>
        </div>

        <h2>Complete Workflow Overview</h2>
        <div class="description">
            <strong>End-to-end visualization of the entire FLAME-ICU federated learning pipeline</strong>
        </div>
        
        <div class="mermaid-container">
            <div class="mermaid">
                graph TB
                    subgraph "Stage 1: Model Development"
                        A[2018-2022 Training Data] --> B[4 Approaches]
                        B --> B1[Approach 1: Cross-Site Validation]
                        B --> B2[Approach 2: Transfer Learning]
                        B --> B3[Approach 3: Independent Training]
                        B --> B4[Approach 4: Round Robin]
                        
                        B1 --> C[Local Testing<br/>2023-2024]
                        B2 --> C
                        B3 --> C
                        B4 --> C
                        
                        C --> D[Models to BOX]
                    end
                    
                    subgraph "Stage 2: Comprehensive Testing"
                        D --> E[Phase 1: Cross-Site Testing]
                        E --> F[Performance Matrix]
                        
                        D --> G[Phase 2: Ensemble Construction]
                        G --> H[Leave-One-Out Testing]
                        
                        F --> I[Final Analysis]
                        H --> I
                        
                        I --> J[Deployment Recommendations]
                    end
                    
                    style A fill:#e1f5fe
                    style B fill:#4fc3f7
                    style C fill:#81c784
                    style D fill:#ba68c8
                    style E fill:#ffb74d
                    style G fill:#ffb74d
                    style I fill:#f06292
                    style J fill:#ff5722
            </div>
        </div>

        <div class="legend">
            <strong>Legend:</strong>
            <div class="legend-item">
                <span class="legend-color" style="background: #e1f5fe;"></span> Data Input
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #4fc3f7;"></span> Processing
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #81c784;"></span> Training/Testing
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #ffb74d;"></span> Distribution
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #ba68c8;"></span> Collection
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #f06292;"></span> Analysis
            </div>
            <div class="legend-item">
                <span class="legend-color" style="background: #ff5722;"></span> Final Output
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#667eea',
                primaryTextColor: '#fff',
                primaryBorderColor: '#7c3aed',
                lineColor: '#5a67d8',
                secondaryColor: '#764ba2',
                tertiaryColor: '#f3f4f6'
            },
            flowchart: {
                curve: 'basis',
                padding: 20,
                nodeSpacing: 50,
                rankSpacing: 50
            }
        });
    </script>
</body>
</html>